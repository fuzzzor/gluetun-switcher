<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="changePasswordTitle">Gluetun-Switcher â€“ Change Password</title>
  <style>
    body { font-family: Arial, sans-serif; background:#705EBD; color:#e5e7eb; display:flex; align-items:center; justify-content:center; height:100vh; }
    .box { background:#2563eb; padding:2rem; border-radius:8px; width:360px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    h1 { text-align:center; margin-top:0; }
    label { display:block; margin-top:1rem; }
    input { width:100%; padding:.5rem; margin-top:.25rem; border-radius:4px; border:1px solid #334155; background:#343538; color:#e5e7eb; }
    button { width:100%; margin-top:1.5rem; padding:.6rem; background:#089F6F; border:none; border-radius:4px; color:white; font-weight:bold; cursor:pointer; }
    .error { color:#D32D27; margin-top:1rem; text-align:center; }
  </style>
</head>
<body>
  <form class="box" onsubmit="changePassword(event)">
    <img src="/icons/change.png" alt="Change password" style="display:block;margin:0 auto 1rem auto;max-width:120px;" />
    <h1 data-i18n="changePasswordTitle">Change password</h1>
    <label>
      <span data-i18n="newPassword">New password</span>
      <input id="password" name="newPassword" type="password" autocomplete="new-password" />
      <small id="policy-info" style="display:block;margin-top:6px;color:#e5e7eb;font-size:0.85em" data-i18n="policyLoading">
        Loading password policy...
      </small>
    </label>
    <button type="submit" data-i18n="updatePasswordButton">Update password</button>
    <div id="error" class="error"></div>
  </form>

<script>
let translations = {};

async function loadTranslations() {
  const lang = navigator.language.startsWith('fr') ? 'fr' : 'en';
  try {
    const res = await fetch(`/locales/${lang}.json`);
    translations = await res.json();
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[key]) el.textContent = translations[key];
    });
    // Reload policy text with translations if policy is already loaded
    if (window.currentPolicy) displayPolicy(window.currentPolicy);
  } catch (e) {
    console.error('Translation load failed', e);
  }
}

function t(key, params = {}) {
  let text = translations[key] || key;
  for (const [k, v] of Object.entries(params)) {
    text = text.replace(`{${k}}`, v);
  }
  return text;
}

async function loadPolicy() {
  try {
    const res = await fetch('/api/auth/policy');
    if (!res.ok) return;
    const policy = await res.json();
    window.currentPolicy = policy; // Store for re-render when translations load
    displayPolicy(policy);
  } catch (e) {
    console.error('Failed to load password policy', e);
  }
}

function displayPolicy(policy) {
  if (Object.keys(translations).length === 0) return; // Wait for translations

  const parts = [];
  if (policy.minLength) {
    parts.push(t('policyMinLength', { length: policy.minLength }));
  }
  
  const reqs = [];
  if (policy.requireUppercase) reqs.push(t('policyUppercase'));
  if (policy.requireLowercase) reqs.push(t('policyLowercase'));
  if (policy.requireDigit) reqs.push(t('policyDigit'));
  if (policy.requireSpecial) reqs.push(t('policySpecial'));
  
  if (reqs.length > 0) {
    parts.push(t('policyRequired', { requirements: reqs.join(', ') }));
  }
  
  const text = parts.join('. ') + (parts.length > 0 ? '.' : '');
  document.getElementById('policy-info').textContent = text;
}

document.addEventListener('DOMContentLoaded', () => {
  loadTranslations();
  loadPolicy();
});

async function changePassword(e) {
  e.preventDefault();
  const password = document.getElementById('password').value;
  const errorDiv = document.getElementById('error');
  
  errorDiv.textContent = ''; 

  try {
    const res = await fetch('/api/auth/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ newPassword: password })
    });

    if (res.ok) {
        window.location.href = '/';
    } else {
      const data = await res.json();
      errorDiv.textContent = data.error || t('networkError');
    }
  } catch (err) {
    console.error(err);
    errorDiv.textContent = t('networkError');
  }
}
</script>
</body>
</html>