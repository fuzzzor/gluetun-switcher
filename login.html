<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title data-i18n="loginTitle">Gluetun-Switcher â€“ Login</title>
  <style>
    body { font-family: Arial, sans-serif; background:#705EBD; color:#e5e7eb; display:flex; align-items:center; justify-content:center; height:100vh; }
    .login { background:#2563eb; padding:2rem; border-radius:8px; width:320px; box-shadow:0 10px 30px rgba(0,0,0,.5); position:relative; padding-top:3.5rem; }
    h1 { margin-top:0; text-align:center; }
    label { display:block; margin-top:1rem; }
    input { width:100%; padding:.5rem; margin-top:.25rem; border-radius:4px; border:1px solid #334155; background:#343538; color:#e5e7eb; }
    button { width:100%; margin-top:1.5rem; padding:.6rem; background:#089F6F; border:none; border-radius:4px; color:white; font-weight:bold; cursor:pointer; }
    .error { color:#D32D27; margin-top:1rem; text-align:center; }
    .footer { margin-top:1.5rem; text-align:center; font-size:0.85rem; color:#000000; }
  </style>
</head>
<body>
  <form class="login" onsubmit="login(); return false;">
    <img src="/icons/logoswitcher.png" alt="Gluetun-Switcher" style="position:absolute; top:-70px; left:50%; transform:translateX(-50%); max-width:120px;" />
    <h1>Gluetun-Switcher</h1>
    <label>
      <span data-i18n="username">Username</span>
      <input id="username" autocomplete="username" autofocus />
    </label>
    <label>
      <span data-i18n="password">Password</span>
      <input id="password" type="password" autocomplete="current-password" />
    </label>
    <button type="submit" data-i18n="signIn">Sign in</button>
    <div id="error" class="error"></div>
    <div class="footer" style="position:relative;">
        2025-2026 - Gluetun-switcher
        <span id="appVersion" style="position:absolute; right:0; bottom:0; opacity:0.5; font-size:0.8em;"></span>
    </div>    
  </form>

<script>
let translations = {};

async function loadTranslations() {
  const lang = navigator.language.startsWith('fr') ? 'fr' : 'en';
  try {
    const res = await fetch(`/locales/${lang}.json`);
    translations = await res.json();
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (translations[key]) el.textContent = translations[key];
    });
  } catch (e) {
    console.error('Translation load failed', e);
  }
}

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;

  const res = await fetch('/api/auth/login', {
    method: 'POST',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();
  if (!data.success) {
    const errorMsg = data.locked ? 
      (translations['accountLocked'] || 'Account locked') : 
      (translations['loginError'] || 'Invalid credentials or user unknown');
    document.getElementById('error').textContent = errorMsg;
    return;
  }

  if (data.mustChangePassword) {
    window.location.href = '/change-password.html';
  } else {
    window.location.href = '/';
  }
}

// Load version
fetch('/api/version')
  .then(r => r.json())
  .then(d => {
    if (d.version) document.getElementById('appVersion').textContent = 'v' + d.version;
  })
  .catch(e => console.error('Failed to load version', e));

loadTranslations();
</script>
</body>
</html>